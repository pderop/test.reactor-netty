name: _build doc job

on:
  workflow_call:
    inputs:
      fetch-depth:
        required: false
        type: string
        default: '1'
      build-refname:
          required: false
          type: string
          default: ''

jobs:
    build-antora:
        name: build-antora
        runs-on: ubuntu-20.04
        env:
            PLAYBOOK: ${{ inputs.playbook }}
            FETCH_DEPTH: ${{ inputs.fetch-depth }}
            BUILD_REFNAME: ${{ inputs.build-refname }}
        steps:
            - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
              with:
                  fetch-depth: ${{ env.FETCH_DEPTH }}
            - name: Set up Ruby
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: 3.3.0
            - name: Install asciidoctor-pdf / rouge
              run: gem install asciidoctor-pdf rouge
            - uses: actions/setup-java@387ac29b308b003ca37ba93a6cab5eb57c8f5f93
              with:
                  distribution: 'temurin'
                  java-version: '17'
            - name: Set up refname build
              if: inputs.build-refname
              run: |
                  git fetch --depth 1 https://github.com/$GITHUB_REPOSITORY $BUILD_REFNAME
                  echo BUILD_VERSION=$(git cat-file --textconv FETCH_HEAD:gradle.properties | sed -n '/^version=/ { s/^version=//;p }') >> $GITHUB_ENV
                  echo BUILD_REFNAME=$BUILD_REFNAME >> $GITHUB_ENV
            - name: build antora
              run: ./gradlew antora
            - name: Copy the cache to be included in the site
              run: |-
                  [ -d docs/build/antora/inject-collector-cache-config-extension/.cache ] && cp -rf docs/build/antora/inject-collector-cache-config-extension/.cache docs/build/site/
            - name: Upload doc
              uses: actions/upload-artifact@v4
              with:
                  name: doc
                  retention-days: 1
                  if-no-files-found: error
                  path: docs/build

